<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Tienda Simple</title>
  </head>
  <body>
    <h1>Tienda</h1>
    <div id="productos"></div>

    <h2>Carrito</h2>
    <ul id="carrito"></ul>

    <button id="finalizar">Finalizar Compra</button>

    <script>
      async function cargarProductos() {
        const res = await fetch("http://localhost:3000/productos");
        const data = await res.json();
        const cont = document.getElementById("productos");
        cont.innerHTML = "";
        data.forEach((p) => {
          const btn = document.createElement("button");
          btn.textContent = "Agregar";
          btn.onclick = () => agregarAlCarrito(p.id);
          const div = document.createElement("div");
          div.textContent = p.nombre + " ";
          div.appendChild(btn);
          cont.appendChild(div);
        });
      }

      function obtenerCarrito() {
        return JSON.parse(localStorage.getItem("carrito")) || [];
      }

      function guardarCarrito(carrito) {
        localStorage.setItem("carrito", JSON.stringify(carrito));
        mostrarCarrito();
      }

      function agregarAlCarrito(id) {
        const carrito = obtenerCarrito();
        carrito.push(id);
        guardarCarrito(carrito);
      }

      function mostrarCarrito() {
        const carrito = obtenerCarrito();
        const ul = document.getElementById("carrito");
        ul.innerHTML = "";
        carrito.forEach((id) => {
          const li = document.createElement("li");
          li.textContent = "Producto ID: " + id;
          ul.appendChild(li);
        });
      }

      async function finalizarCompra() {
        const carrito = obtenerCarrito();
        if (carrito.length === 0) {
          alert("Carrito vacio");
          return;
        }
        const res = await fetch("http://localhost:3000/comprar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids: carrito }),
        });
        const data = await res.json();
        alert(data.mensaje);
        localStorage.removeItem("carrito");
        mostrarCarrito();
      }

      document.getElementById("finalizar").onclick = finalizarCompra;

      cargarProductos();
      mostrarCarrito();
    </script>
  </body>
</html>
